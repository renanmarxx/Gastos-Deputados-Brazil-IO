# Initial workflow name
name: Connect to an AWS role from a GitHub repository

# Controls when actions will be executed. Invokes the workflow on push events, but only for the main branch.
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

name: Connect to an AWS role from a GitHub repository

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: "us-east-1"

permissions:
  id-token: write
  contents: read

jobs:
  AssumeRoleAndCallIdentity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::535942231592:role/GitHub_Actions_Personal # altere para a ARN da sua IAM role
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ env.AWS_REGION }}

      - name: STS GetCallerIdentity
        run: aws sts get-caller-identity

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.6'
          architecture: 'x64'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Cache Poetry and pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Install dependencies (Poetry)
        run: |
          poetry install --no-interaction --no-ansi

      - name: Generate CSV
        env:
          BRASIL_IO_TOKEN: ${{ secrets.BRASIL_IO_TOKEN }}
        run: |
          # script writes output to data/ by default
          poetry run python scripts/brasil_io.py

      - name: Upload to S3
        run: |
          aws s3 cp data/gastos-deputados_cota_parlamentar.csv.gz s3://meu-bucket-exemplo/

# Observações:
# - Configure o secret 'BRASIL_IO_TOKEN' em Settings -> Secrets do repositório.
# - Ajuste a ARN da role e o bucket S3 conforme sua conta.


